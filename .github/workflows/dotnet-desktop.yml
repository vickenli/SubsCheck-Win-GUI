name: "Windows Portable Release Build"

on:
  push:
    tags: 
      - 'v*'
  workflow_dispatch:

jobs:
  build_windows_artifact:
    runs-on: windows-latest

    steps:
      - name: ⬇️ Checkout code (检出您的 GUI 仓库)
        uses: actions/checkout@v4

      # --- 1. 安装构建环境和依赖 ---
      
      - name: 🛠️ Setup Go environment (安装 Go 环境)
        uses: actions/setup-go@v5
        with:
          go-version: '1.21' 

      - name: 🛠️ Setup .NET Core (安装 .NET 环境)
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '6.0.x' 

      # --- 2. 绕过 Go 模块检查，拉取内核并编译 subs-check.exe ---
      
      - name: 📥 Clone Go Kernel and Build subs-check.exe
        shell: powershell
        run: |
          # 【!!! 最终解决方案: 强制初始化主仓库 Go 模块，绕过检查 !!!】
          Write-Host ">>> 绕过 Go 检查: 在主仓库根目录强制创建 Go 模块 <<<"
          # 即使 Go 模块文件存在，我们仍然会执行这个命令，它不会覆盖真实的 Go 模块。
          # 这是一个虚假的模块，仅用于满足 Go 工具链的检查。
          go mod init github.com/${{ github.repository }}/dummy-module
          
          # Go 内核的仓库地址 (从您的截图得知为 beck-8/subs-check)
          $KernelRepoUrl = "https://github.com/beck-8/subs-check.git" 
          $KernelDir = "go-kernel-source" 
          $OutputExe = "subs-check.exe"
          
          Write-Host "正在拉取 Go 内核源码：$KernelRepoUrl"
          git clone $KernelRepoUrl $KernelDir
          
          # 2. 切换到内核源码目录
          cd $KernelDir
          
          # 3. 整理和下载依赖 (在拉取的子仓库中执行)
          Write-Host "正在整理 Go 模块依赖..."
          go mod tidy
          
          # 4. 编译 Go 项目并输出到工作区根目录
          # 编译当前目录下的 'main.go'
          Write-Host "正在编译 Go 内核..."
          go build -ldflags "-s -w" -o ../$OutputExe main.go 
          
          # 检查编译结果
          if (-not (Test-Path ../$OutputExe)) {
              Write-Error "错误：Go 内核编译失败，未生成 $OutputExe 文件！"
              exit 1
          }
          
          # 返回工作区根目录
          cd ..

      # --- 3. 编译 subs-check.win.gui.exe (C# / .NET) ---
      
      - name: 🖥️ Build GUI and Dependencies (编译 GUI 和依赖文件)
        shell: powershell
        run: |
          # 解决方案名为 subs-check.win.gui.sln
          $GuiProjectName = "subs-check.win.gui.sln" 
          $OutputFolder = "${{ github.workspace }}/gui_build_output"
          
          dotnet publish $GuiProjectName `
            --configuration Release `
            --runtime win-x86 `
            -o $OutputFolder

          # 移动编译结果和依赖DLLs到根目录
          Copy-Item -Path "$OutputFolder\subs-check.win.gui.exe" -Destination ${{ github.workspace }}
          Copy-Item -Path "$OutputFolder\Newtonsoft.Json.dll" -Destination ${{ github.workspace }}
          Copy-Item -Path "$OutputFolder\Newtonsoft.Json.xml" -Destination ${{ github.workspace }}
          Copy-Item -Path "$OutputFolder\YamlDotNet.dll" -Destination ${{ github.workspace }}
          Copy-Item -Path "$OutputFolder\YamlDotNet.xml" -Destination ${{ github.workspace }}
          

      # --- 4. 准备其他文件和目录结构 ---
      
      - name: 📦 Prepare Release Files (准备配置和预编译文件)
        shell: powershell
        run: |
          # 创建 config 和 output 目录
          New-Item -ItemType Directory -Path config
          New-Item -ItemType Directory -Path output
          
          # 复制预编译文件 (假设它们在仓库根目录)
          Copy-Item -Path Upgrade.exe -Destination ${{ github.workspace }}
          Copy-Item -Path subs-check_Windows_i386.zip -Destination ${{ github.workspace }}
          

      # --- 5. 压缩所有文件到 ZIP ---
      
      - name: 💾 Compress All Files (压缩文件)
        shell: powershell
        run: |
          $TagName = "${{ github.ref_name }}"
          $ZipName = "SubCheck-Portable-$TagName.zip"
          
          Compress-Archive `
            -Path subs-check.exe, subs-check.win.gui.exe, Upgrade.exe, `
                    Newtonsoft.Json.dll, Newtonsoft.Json.xml, `
                    YamlDotNet.dll, YamlDotNet.xml, `
                    subs-check_Windows_i386.zip, `
                    config, output `
            -DestinationPath $ZipName

      # --- 6. 上传到 Release Assets ---
      
      - name: 📤 Upload Release Asset (上传到 Release)
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: SubCheck-Portable-*.zip
          token: ${{ secrets.GITHUB_TOKEN }}
