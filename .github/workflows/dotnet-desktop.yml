name: "Windows Portable Release Build"

on:
  push:
    tags: 
      - 'v*'
  workflow_dispatch:

jobs:
  build_windows_artifact:
    runs-on: windows-latest

    steps:
      - name: â¬‡ï¸ Checkout code (æ£€å‡ºæ‚¨çš„ GUI ä»“åº“)
        uses: actions/checkout@v4

      # --- 1. å®‰è£…æ„å»ºç¯å¢ƒå’Œä¾èµ– ---
      - name: ğŸ› ï¸ Setup Go environment (å®‰è£… Go ç¯å¢ƒ)
        uses: actions/setup-go@v5
        with:
          go-version: '1.21' 
          # ä¿®å¤ç¼“å­˜é—®é¢˜ï¼šæ˜¾å¼æŒ‡å®šç¼“å­˜è·¯å¾„ï¼Œé¿å…æ‰¾ä¸»ä»“åº“çš„ go.sum
          cache: false 

      - name: ğŸ› ï¸ Setup .NET Core (å®‰è£… .NET ç¯å¢ƒ)
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '6.0.x' 

      # --- 2. æ‹‰å– Go å†…æ ¸æºç å¹¶ç¼–è¯‘ subs-check.exe ---
      - name: ğŸ“¥ Clone Go Kernel and Build subs-check.exe
        shell: powershell
        run: |
          # Go å†…æ ¸çš„ä»“åº“åœ°å€
          $KernelRepoUrl = "https://github.com/beck-8/subs-check.git" 
          $KernelDir = "go-kernel-source" 
          $OutputExe = "subs-check.exe"
          
          Write-Host "æ­£åœ¨æ‹‰å– Go å†…æ ¸æºç ï¼š$KernelRepoUrl"
          git clone $KernelRepoUrl $KernelDir
          
          # 1. åˆ‡æ¢åˆ°å†…æ ¸æºç ç›®å½•
          cd $KernelDir
          
          # ã€å…³é”®ä¿®å¤1ã€‘åœ¨å­ä»“åº“ç›®å½•åˆå§‹åŒ– Go æ¨¡å—ï¼ˆè§£å†³ main module é”™è¯¯ï¼‰
          Write-Host "æ­£åœ¨åˆå§‹åŒ– Go æ¨¡å—..."
          go mod init github.com/beck-8/subs-check
          
          # 2. æ•´ç†å’Œä¸‹è½½ä¾èµ– (åœ¨æ‹‰å–çš„å­ä»“åº“ä¸­æ‰§è¡Œ)
          Write-Host "æ­£åœ¨æ•´ç† Go æ¨¡å—ä¾èµ–..."
          go mod tidy
          
          # 3. ç¼–è¯‘ Go é¡¹ç›®å¹¶è¾“å‡ºåˆ°å·¥ä½œåŒºæ ¹ç›®å½•
          Write-Host "æ­£åœ¨ç¼–è¯‘ Go å†…æ ¸..."
          go build -ldflags "-s -w" -o ../$OutputExe main.go 
          
          # æ£€æŸ¥ç¼–è¯‘ç»“æœ
          if (-not (Test-Path ../$OutputExe)) {
              Write-Error "é”™è¯¯ï¼šGo å†…æ ¸ç¼–è¯‘å¤±è´¥ï¼Œæœªç”Ÿæˆ $OutputExe æ–‡ä»¶ï¼"
              exit 1
          }
          
          # è¿”å›å·¥ä½œåŒºæ ¹ç›®å½•
          cd ..

      # --- 3. ç¼–è¯‘ subs-check.win.gui.exe (C# / .NET) ---
      - name: ğŸ–¥ï¸ Build GUI and Dependencies (ç¼–è¯‘ GUI å’Œä¾èµ–æ–‡ä»¶)
        shell: powershell
        run: |
          # è§£å†³æ–¹æ¡ˆåä¸º subs-check.win.gui.sln
          $GuiProjectName = "subs-check.win.gui.sln" 
          $OutputFolder = "${{ github.workspace }}/gui_build_output"
          
          dotnet publish $GuiProjectName `
            --configuration Release `
            --runtime win-x86 `
            -o $OutputFolder `
            --self-contained false # å¯é€‰ï¼šå‡å°‘ä½“ç§¯ï¼Œä¸åŒ…å«.NETè¿è¡Œæ—¶

          # ç§»åŠ¨ç¼–è¯‘ç»“æœå’Œä¾èµ–DLLsåˆ°æ ¹ç›®å½•
          Copy-Item -Path "$OutputFolder\subs-check.win.gui.exe" -Destination ${{ github.workspace }} -Force
          Copy-Item -Path "$OutputFolder\Newtonsoft.Json.dll" -Destination ${{ github.workspace }} -Force
          Copy-Item -Path "$OutputFolder\Newtonsoft.Json.xml" -Destination ${{ github.workspace }} -Force
          Copy-Item -Path "$OutputFolder\YamlDotNet.dll" -Destination ${{ github.workspace }} -Force
          Copy-Item -Path "$OutputFolder\YamlDotNet.xml" -Destination ${{ github.workspace }} -Force

      # --- 4. å‡†å¤‡å…¶ä»–æ–‡ä»¶å’Œç›®å½•ç»“æ„ ---
      - name: ğŸ“¦ Prepare Release Files (å‡†å¤‡é…ç½®å’Œé¢„ç¼–è¯‘æ–‡ä»¶)
        shell: powershell
        run: |
          # åˆ›å»º config å’Œ output ç›®å½•
          New-Item -ItemType Directory -Path config -Force
          New-Item -ItemType Directory -Path output -Force
          
          # å¤åˆ¶é¢„ç¼–è¯‘æ–‡ä»¶ (å‡è®¾å®ƒä»¬åœ¨ä»“åº“æ ¹ç›®å½•ï¼Œä¸å­˜åœ¨åˆ™è·³è¿‡)
          if (Test-Path Upgrade.exe) {
              Copy-Item -Path Upgrade.exe -Destination ${{ github.workspace }} -Force
          } else {
              Write-Warning "è­¦å‘Šï¼šæœªæ‰¾åˆ° Upgrade.exeï¼Œè·³è¿‡å¤åˆ¶"
          }
          if (Test-Path subs-check_Windows_i386.zip) {
              Copy-Item -Path subs-check_Windows_i386.zip -Destination ${{ github.workspace }} -Force
          } else {
              Write-Warning "è­¦å‘Šï¼šæœªæ‰¾åˆ° subs-check_Windows_i386.zipï¼Œè·³è¿‡å¤åˆ¶"
          }

      # --- 5. å‹ç¼©æ‰€æœ‰æ–‡ä»¶åˆ° ZIP ---
      - name: ğŸ’¾ Compress All Files (å‹ç¼©æ–‡ä»¶)
        shell: powershell
        run: |
          $TagName = "${{ github.ref_name }}"
          $ZipName = "SubCheck-Portable-$TagName.zip"
          
          # æ”¶é›†è¦å‹ç¼©çš„æ–‡ä»¶ï¼ˆè¿‡æ»¤ä¸å­˜åœ¨çš„æ–‡ä»¶ï¼Œé¿å…å‹ç¼©å¤±è´¥ï¼‰
          $filesToCompress = @()
          $targetFiles = @(
              "subs-check.exe", 
              "subs-check.win.gui.exe", 
              "Upgrade.exe",
              "Newtonsoft.Json.dll", 
              "Newtonsoft.Json.xml",
              "YamlDotNet.dll", 
              "YamlDotNet.xml",
              "subs-check_Windows_i386.zip",
              "config", 
              "output"
          )
          foreach ($file in $targetFiles) {
              if (Test-Path $file) {
                  $filesToCompress += $file
              } else {
                  Write-Warning "è­¦å‘Šï¼šæ–‡ä»¶ $file ä¸å­˜åœ¨ï¼Œè·³è¿‡å‹ç¼©"
              }
          }
          
          # æ‰§è¡Œå‹ç¼©
          Compress-Archive `
            -Path $filesToCompress `
            -DestinationPath $ZipName `
            -Force

      # --- 6. ä¸Šä¼ åˆ° Release Assets ---
      - name: ğŸ“¤ Upload Release Asset (ä¸Šä¼ åˆ° Release)
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: SubCheck-Portable-*.zip
          token: ${{ secrets.GITHUB_TOKEN }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
