name: "Windows Portable Release Build"

on:
  push:
    tags: 
      - 'v*' # ä»…åœ¨æ¨é€ç‰ˆæœ¬æ ‡ç­¾æ—¶è§¦å‘
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨ç‚¹å‡»è¿è¡Œ

jobs:
  build_windows_artifact:
    runs-on: windows-latest # ç¡®ä¿åœ¨ Windows ç¯å¢ƒä¸‹ç¼–è¯‘

    steps:
      - name: â¬‡ï¸ Checkout code (æ£€å‡ºä»£ç )
        uses: actions/checkout@v4
        with:
          fetch-depth: 1 # ä»…æ‹‰å–æœ€æ–°ä»£ç ï¼ŒåŠ é€Ÿæ£€å‡º

      # --- 1. å®‰è£…æ„å»ºç¯å¢ƒå’Œä¾èµ– ---
      
      - name: ğŸ› ï¸ Setup Go environment (å®‰è£… Go ç¯å¢ƒ)
        uses: actions/setup-go@v5
        with:
          go-version: '1.21' 
          cache: false # ç¦ç”¨ç¼“å­˜ï¼Œé¿å…å›  go.sum ç¼ºå¤±æŠ¥é”™

      - name: ğŸ› ï¸ Setup .NET Core (å®‰è£… .NET ç¯å¢ƒ)
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '6.0.x' 

      # --- 2. ç¼–è¯‘æ ¸å¿ƒ subs-check.exe å†…æ ¸ (Go) ---
      
      - name: âš™ï¸ Build subs-check.exe (ç¼–è¯‘ Go å†…æ ¸)
        shell: powershell
        run: |
          # ã€å…³é”®ä¿®å¤ã€‘å®šä¹‰ Go æºç çš„å®é™…ç›®å½•ï¼ˆæ ¹æ®ä½ çš„ä»“åº“ç»“æ„è°ƒæ•´ï¼ï¼‰
          $GoSrcDir = "${{ github.workspace }}/subs-check-go-kernel/cmd"
          $OutputExe = "${{ github.workspace }}/subs-check.exe"
          
          # æ ¡éªŒ Go æºç ç›®å½•æ˜¯å¦å­˜åœ¨
          if (-not (Test-Path $GoSrcDir)) {
              Write-Error "é”™è¯¯ï¼šGo æºç ç›®å½•ä¸å­˜åœ¨ï¼è·¯å¾„ï¼š$GoSrcDir"
              Write-Error "è¯·ç¡®è®¤ä»“åº“ä¸­æ˜¯å¦æœ‰ subs-check-go-kernel/cmd/ ç›®å½•ï¼Œæˆ–ä¿®æ”¹ GoSrcDir ä¸ºæ­£ç¡®è·¯å¾„"
              exit 1
          }
          
          # åˆ‡æ¢åˆ° Go æºç ç›®å½•
          cd $GoSrcDir
          
          # æ•´ç†å’Œä¸‹è½½ä¾èµ– (åŸºäºå½“å‰æºç ç›®å½•çš„ go.mod)
          Write-Host "æ­£åœ¨æ•´ç† Go æ¨¡å—ä¾èµ–ï¼ˆç›®å½•ï¼š$GoSrcDirï¼‰..."
          go mod tidy -v
          
          # ç¼–è¯‘ Go é¡¹ç›®ï¼ˆè¾“å‡ºåˆ°ä»“åº“æ ¹ç›®å½•ï¼‰
          Write-Host "æ­£åœ¨ç¼–è¯‘ Go å†…æ ¸ï¼ˆè¾“å‡ºåˆ°ï¼š$OutputExeï¼‰..."
          go build -ldflags "-s -w" -o $OutputExe main.go
          
          # æ£€æŸ¥ç¼–è¯‘ç»“æœ
          if (-not (Test-Path $OutputExe)) {
              Write-Error "é”™è¯¯ï¼šGo å†…æ ¸ç¼–è¯‘å¤±è´¥ï¼Œæœªç”Ÿæˆ subs-check.exe æ–‡ä»¶ï¼"
              exit 1
          }
          Write-Host "âœ… Go å†…æ ¸ç¼–è¯‘æˆåŠŸï¼š$OutputExe"

      # --- 3. ç¼–è¯‘ subs-check.win.gui.exe (C# / .NET) ---
      
      - name: ğŸ–¥ï¸ Build GUI and Dependencies (ç¼–è¯‘ GUI å’Œä¾èµ–æ–‡ä»¶)
        shell: powershell
        run: |
          $GuiProjectName = "subs-check.win.gui.sln" 
          $OutputFolder = "${{ github.workspace }}/gui_build_output"
          
          # æ ¡éªŒè§£å†³æ–¹æ¡ˆæ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if (-not (Test-Path $GuiProjectName)) {
              Write-Error "é”™è¯¯ï¼š.NET è§£å†³æ–¹æ¡ˆæ–‡ä»¶ä¸å­˜åœ¨ï¼è·¯å¾„ï¼š$GuiProjectName"
              exit 1
          }
          
          # å‘å¸ƒ GUI é¡¹ç›®
          dotnet publish $GuiProjectName `
            --configuration Release `
            --runtime win-x86 `
            -o $OutputFolder `
            --self-contained false # å¯é€‰ï¼šå‡å°‘ä½“ç§¯ï¼Œä¸ä¾èµ–ç³»ç»Ÿ.NETè¿è¡Œæ—¶

          # ç§»åŠ¨ç¼–è¯‘ç»“æœå’Œä¾èµ–DLLsåˆ°æ ¹ç›®å½• (å¯¹åº”æœ€ç»ˆæ–‡ä»¶ç»“æ„)
          $targetFiles = @(
              "subs-check.win.gui.exe",
              "Newtonsoft.Json.dll",
              "Newtonsoft.Json.xml",
              "YamlDotNet.dll",
              "YamlDotNet.xml"
          )
          foreach ($file in $targetFiles) {
              $srcPath = "$OutputFolder\$file"
              $dstPath = "${{ github.workspace }}\$file"
              if (Test-Path $srcPath) {
                  Copy-Item -Path $srcPath -Destination $dstPath -Force
                  Write-Host "âœ… å¤åˆ¶æ–‡ä»¶ï¼š$file"
              } else {
                  Write-Warning "è­¦å‘Šï¼š.NET ç¼–è¯‘äº§ç‰©ç¼ºå¤±ï¼Œè·³è¿‡å¤åˆ¶ï¼š$file"
              }
          }

      # --- 4. å‡†å¤‡å…¶ä»–æ–‡ä»¶å’Œç›®å½•ç»“æ„ ---
      
      - name: ğŸ“¦ Prepare Release Files (å‡†å¤‡é…ç½®å’Œé¢„ç¼–è¯‘æ–‡ä»¶)
        shell: powershell
        run: |
          # åˆ›å»º config å’Œ output ç›®å½•ï¼ˆå¼ºåˆ¶åˆ›å»ºï¼Œé¿å…å·²å­˜åœ¨æŠ¥é”™ï¼‰
          New-Item -ItemType Directory -Path "${{ github.workspace }}/config" -Force
          New-Item -ItemType Directory -Path "${{ github.workspace }}/output" -Force
          
          # å¤åˆ¶é¢„ç¼–è¯‘æ–‡ä»¶ (ä¸å­˜åœ¨åˆ™è·³è¿‡å¹¶è­¦å‘Š)
          $preFiles = @("Upgrade.exe", "subs-check_Windows_i386.zip")
          foreach ($file in $preFiles) {
              $srcPath = "${{ github.workspace }}\$file"
              $dstPath = $srcPath
              if (Test-Path $srcPath) {
                  Copy-Item -Path $srcPath -Destination $dstPath -Force
                  Write-Host "âœ… å¤åˆ¶é¢„ç¼–è¯‘æ–‡ä»¶ï¼š$file"
              } else {
                  Write-Warning "è­¦å‘Šï¼šé¢„ç¼–è¯‘æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡å¤åˆ¶ï¼š$file"
              }
          }

      # --- 5. å‹ç¼©æ‰€æœ‰æ–‡ä»¶åˆ° ZIP ---
      
      - name: ğŸ’¾ Compress All Files (å‹ç¼©æ–‡ä»¶)
        shell: powershell
        run: |
          $TagName = "${{ github.ref_name }}"
          $ZipName = "SubCheck-Portable-$TagName.zip"
          $ZipPath = "${{ github.workspace }}\$ZipName"
          
          # æ”¶é›†è¦å‹ç¼©çš„æ–‡ä»¶ï¼ˆè¿‡æ»¤ä¸å­˜åœ¨çš„æ–‡ä»¶ï¼Œé¿å…å‹ç¼©å¤±è´¥ï¼‰
          $filesToCompress = @()
          $targetPaths = @(
              "subs-check.exe",
              "subs-check.win.gui.exe",
              "Upgrade.exe",
              "Newtonsoft.Json.dll",
              "Newtonsoft.Json.xml",
              "YamlDotNet.dll",
              "YamlDotNet.xml",
              "subs-check_Windows_i386.zip",
              "config",
              "output"
          )
          foreach ($path in $targetPaths) {
              $fullPath = "${{ github.workspace }}\$path"
              if (Test-Path $fullPath) {
                  $filesToCompress += $fullPath
                  Write-Host "âœ… åŠ å…¥å‹ç¼©ï¼š$path"
              } else {
                  Write-Warning "è­¦å‘Šï¼šæ–‡ä»¶/ç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡å‹ç¼©ï¼š$path"
              }
          }
          
          # æ‰§è¡Œå‹ç¼©ï¼ˆå¼ºåˆ¶è¦†ç›–å·²å­˜åœ¨çš„ ZIPï¼‰
          if ($filesToCompress.Count -gt 0) {
              Compress-Archive -Path $filesToCompress -DestinationPath $ZipPath -Force
              Write-Host "âœ… å‹ç¼©å®Œæˆï¼š$ZipPath"
          } else {
              Write-Error "é”™è¯¯ï¼šæ— å¯ç”¨æ–‡ä»¶è¿›è¡Œå‹ç¼©ï¼"
              exit 1
          }

      # --- 6. ä¸Šä¼ åˆ° Release Assets ---
      
      - name: ğŸ“¤ Upload Release Asset (ä¸Šä¼ åˆ° Release)
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: "${{ github.workspace }}/SubCheck-Portable-*.zip"
          token: ${{ secrets.GITHUB_TOKEN }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
