name: "Windows Portable Release Build"

on:
  push:
    tags: 
      - 'v*' # ä»…åœ¨æ¨é€ç‰ˆæœ¬æ ‡ç­¾æ—¶è§¦å‘ï¼Œä¾‹å¦‚ git push origin v1.0.0
  workflow_dispatch: # å…è®¸åœ¨ GitHub é¡µé¢æ‰‹åŠ¨ç‚¹å‡»è¿è¡Œ

jobs:
  build_windows_artifact:
    runs-on: windows-latest # ç¡®ä¿åœ¨ Windows ç¯å¢ƒä¸‹ç¼–è¯‘ï¼Œä»¥ç”Ÿæˆ EXE æ–‡ä»¶

    steps:
      - name: â¬‡ï¸ Checkout code (æ£€å‡ºä»£ç )
        uses: actions/checkout@v4

      # --- 1. å®‰è£…æ„å»ºç¯å¢ƒå’Œä¾èµ– ---
      
      - name: ğŸ› ï¸ Setup Go environment (å®‰è£… Go ç¯å¢ƒ)
        uses: actions/setup-go@v5
        with:
          go-version: '1.21' # æ‚¨å¯ä»¥æ ¹æ®æ‚¨çš„ Go å†…æ ¸å®é™…ç‰ˆæœ¬è¿›è¡Œè°ƒæ•´

      - name: ğŸ› ï¸ Setup .NET Core (å®‰è£… .NET ç¯å¢ƒ)
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '6.0.x' # å‡è®¾ä½¿ç”¨ .NET 6 è¿›è¡Œç¼–è¯‘

      # --- 2. ç¼–è¯‘æ ¸å¿ƒ subs-check.exe å†…æ ¸ (Go) ---
      
      - name: âš™ï¸ Build subs-check.exe (ç¼–è¯‘ Go å†…æ ¸)
        shell: powershell
        run: |
          # ã€!!! é‡è¦ä¿®æ”¹ !!!ã€‘
          # è¯·å°† 'subs-check-go-kernel' æ›¿æ¢ä¸ºæ‚¨Goæºç æ‰€åœ¨çš„æ–‡ä»¶å¤¹åç§°
          $KernelDir = "subs-check-go-kernel" 
          
          # æ£€æŸ¥ Go æºç ç›®å½•æ˜¯å¦å­˜åœ¨
          if (-not (Test-Path $KernelDir)) {
             Write-Error "æ‰¾ä¸åˆ°Goæºç ç›®å½• '$KernelDir'ï¼Œè¯·æ£€æŸ¥è·¯å¾„æ˜¯å¦æ­£ç¡®ã€‚"
             exit 1
          }
          
          # 1. åˆ‡æ¢åˆ°å†…æ ¸æºç ç›®å½•
          cd $KernelDir
          
          # 2. å¦‚æœ go.mod ä¸å­˜åœ¨ï¼Œåˆå§‹åŒ–ä¸€ä¸ª Go æ¨¡å—
          if (-not (Test-Path go.mod)) {
            Write-Host "go.mod æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ­£åœ¨åˆå§‹åŒ–æ¨¡å—..."
            # è¿™é‡Œçš„è·¯å¾„ç”¨ä»“åº“åä»£æ›¿ï¼ŒGoæ‰èƒ½è¯†åˆ«ä¸ºæ¨¡å—
            go mod init github.com/${{ github.repository }} 
          }
          
          # 3. æ•´ç†å’Œä¸‹è½½ä¾èµ–
          go mod tidy
          
          # 4. ç¼–è¯‘ Go é¡¹ç›®å¹¶è¾“å‡ºåˆ°å·¥ä½œåŒºæ ¹ç›®å½•
          # å‡è®¾å…¥å£æ–‡ä»¶æ˜¯ main.goï¼Œå¹¶æŒ‡å®šè¾“å‡ºè·¯å¾„ä¸ºä¸Šä¸€çº§ç›®å½•
          go build -ldflags "-s -w" -o ../subs-check.exe main.go 
          
          # è¿”å›å·¥ä½œåŒºæ ¹ç›®å½•
          cd ..

      # --- 3. ç¼–è¯‘ subs-check.win.gui.exe (C# / .NET) ---
      
      - name: ğŸ–¥ï¸ Build GUI and Dependencies (ç¼–è¯‘ GUI å’Œä¾èµ–æ–‡ä»¶)
        shell: powershell
        run: |
          $GuiProjectName = "subs-check.win.gui.sln" 
          $OutputFolder = "${{ github.workspace }}/gui_build_output"
          
          # ç¼–è¯‘å¹¶å‘å¸ƒ GUI é¡¹ç›®
          dotnet publish $GuiProjectName `
            --configuration Release `
            --runtime win-x86 ` # ç›®æ ‡å¹³å° x86/i386
            -o $OutputFolder

          # ç§»åŠ¨å…³é”®çš„ GUI æ–‡ä»¶åˆ°æ ¹ç›®å½• (å‡†å¤‡æ‰“åŒ…)
          # ç¼–è¯‘åçš„ä¸»EXEå
          Copy-Item -Path "$OutputFolder\subs-check.win.gui.exe" -Destination ${{ github.workspace }}
          
          # ç§»åŠ¨æ‰€æœ‰å¿…è¦çš„ DLL å’Œ XML ä¾èµ–æ–‡ä»¶
          Copy-Item -Path "$OutputFolder\Newtonsoft.Json.dll" -Destination ${{ github.workspace }}
          Copy-Item -Path "$OutputFolder\Newtonsoft.Json.xml" -Destination ${{ github.workspace }}
          Copy-Item -Path "$OutputFolder\YamlDotNet.dll" -Destination ${{ github.workspace }}
          Copy-Item -Path "$OutputFolder\YamlDotNet.xml" -Destination ${{ github.workspace }}
          
          # æ³¨æ„ï¼šå¦‚æœè¿˜æœ‰å…¶ä»–å¿…è¦çš„ DLLï¼Œéœ€è¦åœ¨è¿™é‡Œæ·»åŠ  Copy-Item å‘½ä»¤

      # --- 4. å‡†å¤‡å…¶ä»–æ–‡ä»¶å’Œç›®å½•ç»“æ„ ---
      
      - name: ğŸ“¦ Prepare Release Files (å‡†å¤‡é…ç½®å’Œé¢„ç¼–è¯‘æ–‡ä»¶)
        shell: powershell
        run: |
          # ç¡®ä¿æœ€ç»ˆå‹ç¼©åŒ…ä¸­çš„ config å’Œ output ç›®å½•å­˜åœ¨
          New-Item -ItemType Directory -Path config
          New-Item -ItemType Directory -Path output
          
          # å¦‚æœæ‚¨çš„ Upgrade.exe å’Œ subs-check_Windows_i386.zip å·²ç»åœ¨ä»“åº“æ ¹ç›®å½•ï¼Œæ— éœ€å¤åˆ¶ã€‚
          # å¦‚æœå®ƒä»¬åœ¨æŸä¸ªå­æ–‡ä»¶å¤¹ (å¦‚ 'prebuilt/')ï¼Œåˆ™éœ€è¦å¤åˆ¶åˆ°æ ¹ç›®å½•ï¼š
          # Copy-Item -Path prebuilt\Upgrade.exe -Destination ${{ github.workspace }}
          # Copy-Item -Path prebuilt\subs-check_Windows_i386.zip -Destination ${{ github.workspace }}
          
          # å‡è®¾é…ç½®æ–‡ä»¶ config.yaml å’Œ more.yaml å·²ç»æ”¾åœ¨ config ç›®å½•
          
      # --- 5. å‹ç¼©æ‰€æœ‰æ–‡ä»¶åˆ° ZIP ---
      
      - name: ğŸ’¾ Compress All Files (å‹ç¼©æ–‡ä»¶)
        shell: powershell
        run: |
          $TagName = "${{ github.ref_name }}"
          $ZipName = "SubCheck-Portable-$TagName.zip"
          
          # å‹ç¼©æ‰€æœ‰ç”Ÿæˆå’Œéœ€è¦çš„æœ€ç»ˆæ–‡ä»¶
          Compress-Archive `
            -Path subs-check.exe, subs-check.win.gui.exe, Upgrade.exe, `
                    Newtonsoft.Json.dll, Newtonsoft.Json.xml, `
                    YamlDotNet.dll, YamlDotNet.xml, `
                    subs-check_Windows_i386.zip, `
                    config, output `
            -DestinationPath $ZipName

      # --- 6. ä¸Šä¼ åˆ° Release Assets ---
      
      - name: ğŸ“¤ Upload Release Asset (ä¸Šä¼ åˆ° Release)
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: SubCheck-Portable-*.zip
          token: ${{ secrets.GITHUB_TOKEN }}
