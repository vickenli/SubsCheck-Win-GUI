name: "Windows Portable Release Build"

on:
  push:
    tags: 
      - 'v*'
  workflow_dispatch:

jobs:
  build_windows_artifact:
    runs-on: windows-latest
    env:
      # å…¨å±€æŒ‡å®š Go ç¼–è¯‘å…¥å£è·¯å¾„ï¼Œé¿å…è·¯å¾„æ··æ·†
      GO_BUILD_ENTRY: "subs-check-go-kernel/cmd/main" # å¯¹é½å®é™…ä»£ç ç›®å½•ç»“æ„
      GO_OUTPUT: "subs-check.exe"

    steps:
      - name: â¬‡ï¸ Checkout code (æ£€å‡ºä»£ç )
        uses: actions/checkout@v4
        with:
          fetch-depth: 1 # æµ…å…‹éš†ï¼Œå‡å°‘ç¼“å­˜å¹²æ‰°

      - name: ğŸ§¹ Full Cleanup (å½»åº•æ¸…ç†ç¼“å­˜)
        shell: powershell
        run: |
          # æ¸…ç†æ‰€æœ‰å¯èƒ½çš„ç¼“å­˜å’Œæ®‹ç•™
          Remove-Item -Path "$env:GOPATH" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "$env:GOROOT" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path ".\go.mod", ".\go.sum" -ErrorAction SilentlyContinue
          go clean -modcache -cache -i -r 2>$null
          Write-Host "ç¼“å­˜æ¸…ç†å®Œæˆ"

      - name: ğŸ› ï¸ Setup Go (ä½¿ç”¨å®˜æ–¹ Action ç¡®ä¿ç¯å¢ƒæ­£ç¡®ï¼Œæ›¿ä»£æ‰‹åŠ¨å®‰è£…é¿å…é…ç½®é—®é¢˜)
        uses: actions/setup-go@v5
        with:
          go-version: '1.21.13'
          cache: false # ç¦ç”¨ç¼“å­˜ï¼Œé¿å…æ—§é…ç½®å¹²æ‰°

      - name: ğŸ› ï¸ Setup .NET Core
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '6.0.x'

      - name: âš™ï¸ Verify Code Structure (æ ¡éªŒç›®å½•ç»“æ„ï¼Œç¡®è®¤å…¥å£å­˜åœ¨)
        shell: powershell
        run: |
          Write-Host "å½“å‰å·¥ä½œç›®å½•: ${{ github.workspace }}"
          Write-Host "æ ¸å¿ƒä»£ç ç›®å½•ç»“æ„:"
          Get-ChildItem -Path $env:GO_BUILD_ENTRY -Recurse # æ‰“å°å…¥å£ç›®å½•æ–‡ä»¶ï¼Œç¡®è®¤å­˜åœ¨
          if (-not (Test-Path $env:GO_BUILD_ENTRY)) {
              Write-Error "è‡´å‘½é”™è¯¯ï¼šGo ç¼–è¯‘å…¥å£ $env:GO_BUILD_ENTRY ä¸å­˜åœ¨ï¼"
              exit 1
          }

      - name: âš™ï¸ Build subs-check.exe (ç¼–è¯‘ Go å†…æ ¸ï¼Œä½¿ç”¨æ­£ç¡®å…¥å£è·¯å¾„)
        shell: powershell
        run: |
          Set-Location ${{ github.workspace }}
          # è¿›å…¥ Go é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ mod tidyï¼ˆç¡®ä¿ä¾èµ–æ­£ç¡®ï¼‰
          Set-Location (Split-Path $env:GO_BUILD_ENTRY -Parent | Split-Path -Parent)
          go mod tidy
          Set-Location ${{ github.workspace }}
          # æ˜ç¡®ä½¿ç”¨æ­£ç¡®å…¥å£è·¯å¾„ç¼–è¯‘
          go build -ldflags "-s -w" -o $env:GO_OUTPUT $env:GO_BUILD_ENTRY
          # æ ¡éªŒè¾“å‡º
          if (-not (Test-Path $env:GO_OUTPUT)) {
              Write-Error "Go ç¼–è¯‘å¤±è´¥ï¼Œæœªç”Ÿæˆ $env:GO_OUTPUT"
              exit 1
          }
          Write-Host "Go å†…æ ¸ç¼–è¯‘æˆåŠŸ"

      - name: ğŸ–¥ï¸ Build GUI and Dependencies
        shell: powershell
        run: |
          $GuiProjectName = "subs-check.win.gui.sln" 
          $OutputFolder = "${{ github.workspace }}/gui_build_output"
          dotnet publish $GuiProjectName --configuration Release --runtime win-x86 -o $OutputFolder
          Copy-Item -Path "$OutputFolder\subs-check.win.gui.exe", "$OutputFolder\*.dll", "$OutputFolder\*.xml" -Destination ${{ github.workspace }} -Force

      - name: ğŸ“¦ Prepare Release Files
        shell: powershell
        run: |
          New-Item -ItemType Directory -Path config, output -Force
          Copy-Item -Path Upgrade.exe, subs-check_Windows_i386.zip -Destination ${{ github.workspace }} -Force -ErrorAction SilentlyContinue

      - name: ğŸ’¾ Compress All Files
        shell: powershell
        run: |
          $ZipName = "SubCheck-Portable-${{ github.ref_name }}.zip"
          Compress-Archive -Path subs-check.exe, subs-check.win.gui.exe, Upgrade.exe, *.dll, *.xml, subs-check_Windows_i386.zip, config, output -DestinationPath $ZipName -Force

      - name: ğŸ“¤ Upload Release Asset
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: SubCheck-Portable-*.zip
          token: ${{ secrets.GITHUB_TOKEN }}
