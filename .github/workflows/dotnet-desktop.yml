name: "Windows Portable Release Build"

on:
  push:
    tags: 
      - 'v*'
  workflow_dispatch:

jobs:
  build_windows_artifact:
    runs-on: windows-latest

    steps:
      - name: â¬‡ï¸ Checkout code (æ£€å‡ºä»£ç )
        uses: actions/checkout@v4
        
      # ç§»é™¤è¯¯åˆ  .git çš„æ¸…ç†æ­¥éª¤ï¼Œä¿ç•™ Go ç¼“å­˜æ¸…ç†å³å¯
      - name: ğŸ§¹ Clean up Go Cache (æ¸…ç† Go ç¼“å­˜)
        shell: powershell
        run: |
          Write-Host "æ­£åœ¨æ¸…ç† Go ç¼“å­˜..."
          if (Test-Path -Path $env:GOPATH) { Remove-Item -Path $env:GOPATH -Recurse -Force }
          go clean -modcache # é¢å¤–æ¸…ç†æ¨¡å—ç¼“å­˜ï¼Œé¿å…ä¾èµ–æ®‹ç•™

      # --- 1. æ‰‹åŠ¨å®‰è£… Go ç¯å¢ƒï¼ˆè¡¥å…¨å…¨å±€ç¯å¢ƒå˜é‡é…ç½®ï¼‰---
      
      - name: ğŸ› ï¸ Setup Go environment Manually (æ‰‹åŠ¨å®‰è£… Go ç¯å¢ƒ)
        shell: powershell
        run: |
          $goVersion = "1.21.13"
          Write-Host "æ­£åœ¨æ‰‹åŠ¨ä¸‹è½½å¹¶å®‰è£… Go $goVersion..."
          
          $goZip = "go$goVersion.windows-amd64.zip"
          $goUrl = "https://golang.org/dl/$goZip"
          Invoke-WebRequest -Uri $goUrl -OutFile $goZip
          
          Expand-Archive -Path $goZip -DestinationPath "C:\" -Force
          
          # é…ç½®å…¨å±€ç¯å¢ƒå˜é‡ï¼ˆåŸä»…å½“å‰ä¼šè¯ç”Ÿæ•ˆï¼Œè¡¥å…¨ Persist ç¡®ä¿åç»­æ­¥éª¤å¯ç”¨ï¼‰
          [Environment]::SetEnvironmentVariable("Path", $env:Path + ";C:\go\bin", "Machine")
          $gopath = "C:\Users\runneradmin\go"
          [Environment]::SetEnvironmentVariable("GOPATH", $gopath, "Machine")
          New-Item -Path $gopath -ItemType Directory -Force # ç¡®ä¿ GOPATH ç›®å½•å­˜åœ¨
          
          $env:Path = [Environment]::GetEnvironmentVariable("Path", "Machine")
          $env:GOPATH = [Environment]::GetEnvironmentVariable("GOPATH", "Machine")
          Write-Host "Go ç¯å¢ƒé…ç½®å®Œæ¯•ã€‚ç‰ˆæœ¬ä¿¡æ¯:"
          go version
          
      - name: ğŸ› ï¸ Setup .NET Core (å®‰è£… .NET ç¯å¢ƒ)
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '6.0.x' 

      # --- 2. ç¼–è¯‘æ ¸å¿ƒ subs-check.exe å†…æ ¸ (Go)ï¼ˆç¡®è®¤è·¯å¾„åŒ¹é…æ ¹ç›®å½• main.goï¼‰---
      
      - name: âš™ï¸ Build subs-check.exe (ç¼–è¯‘ Go å†…æ ¸)
        shell: powershell
        run: |
          $Workspace = "${{ github.workspace }}"
          Set-Location $Workspace
          
          Write-Host "å½“å‰å·¥ä½œç›®å½•: $Workspace"
          Write-Host "ç›®å½•æ–‡ä»¶åˆ—è¡¨:"
          Get-ChildItem # æ‰“å°æ–‡ä»¶åˆ—è¡¨ï¼Œç¡®è®¤ main.go å­˜åœ¨
          
          Write-Host "æ­£åœ¨æ•´ç† Go æ¨¡å—ä¾èµ–..."
          go mod tidy
          
          # æ˜ç¡®ç¼–è¯‘æ ¹ç›®å½• main.goï¼ŒåŒ¹é…å®é™…æ–‡ä»¶è·¯å¾„
          $BuildCommand = "go build -ldflags ""-s -w"" -o subs-check.exe main.go"
          Write-Host "æ‰§è¡Œç¼–è¯‘å‘½ä»¤: $BuildCommand"
          Invoke-Expression $BuildCommand
          
          if (-not (Test-Path subs-check.exe)) {
              Write-Error "é”™è¯¯ï¼šGo å†…æ ¸ç¼–è¯‘å¤±è´¥ï¼Œæœªç”Ÿæˆ subs-check.exe æ–‡ä»¶ï¼"
              exit 1
          }
          Write-Host "Go å†…æ ¸ç¼–è¯‘æˆåŠŸ"

      # --- 3. ç¼–è¯‘ subs-check.win.gui.exe (C# / .NET) ---
      
      - name: ğŸ–¥ï¸ Build GUI and Dependencies (ç¼–è¯‘ GUI å’Œä¾èµ–æ–‡ä»¶)
        shell: powershell
        run: |
          $GuiProjectName = "subs-check.win.gui.sln" 
          $OutputFolder = "${{ github.workspace }}/gui_build_output"
          
          dotnet publish $GuiProjectName `
            --configuration Release `
            --runtime win-x86 `
            -o $OutputFolder

          Copy-Item -Path "$OutputFolder\subs-check.win.gui.exe" -Destination ${{ github.workspace }}
          Copy-Item -Path "$OutputFolder\Newtonsoft.Json.dll" -Destination ${{ github.workspace }}
          Copy-Item -Path "$OutputFolder\Newtonsoft.Json.xml" -Destination ${{ github.workspace }}
          Copy-Item -Path "$OutputFolder\YamlDotNet.dll" -Destination ${{ github.workspace }}
          Copy-Item -Path "$OutputFolder\YamlDotNet.xml" -Destination ${{ github.workspace }}
          

      # --- 4. å‡†å¤‡å…¶ä»–æ–‡ä»¶å’Œç›®å½•ç»“æ„ ---
      
      - name: ğŸ“¦ Prepare Release Files (å‡†å¤‡é…ç½®å’Œé¢„ç¼–è¯‘æ–‡ä»¶)
        shell: powershell
        run: |
          New-Item -ItemType Directory -Path config -Force
          New-Item -ItemType Directory -Path output -Force
          
          # å¢åŠ æ–‡ä»¶å­˜åœ¨æ ¡éªŒï¼Œé¿å…æ‹·è´å¤±è´¥
          if (Test-Path Upgrade.exe) { Copy-Item -Path Upgrade.exe -Destination ${{ github.workspace }} }
          else { Write-Warning "Upgrade.exe ä¸å­˜åœ¨ï¼Œè·³è¿‡æ‹·è´" }
          if (Test-Path subs-check_Windows_i386.zip) { Copy-Item -Path subs-check_Windows_i386.zip -Destination ${{ github.workspace }} }
          else { Write-Warning "subs-check_Windows_i386.zip ä¸å­˜åœ¨ï¼Œè·³è¿‡æ‹·è´" }
          

      # --- 5. å‹ç¼©æ‰€æœ‰æ–‡ä»¶åˆ° ZIP ---
      
      - name: ğŸ’¾ Compress All Files (å‹ç¼©æ–‡ä»¶)
        shell: powershell
        run: |
          $TagName = "${{ github.ref_name }}"
          $ZipName = "SubCheck-Portable-$TagName.zip"
          
          Compress-Archive `
            -Path subs-check.exe, subs-check.win.gui.exe, Upgrade.exe, `
                    Newtonsoft.Json.dll, Newtonsoft.Json.xml, `
                    YamlDotNet.dll, YamlDotNet.xml, `
                    subs-check_Windows_i386.zip, `
                    config, output `
            -DestinationPath $ZipName -Force # åŠ  -Force è¦†ç›–å·²æœ‰æ–‡ä»¶

      # --- 6. ä¸Šä¼ åˆ° Release Assets ---
      
      - name: ğŸ“¤ Upload Release Asset (ä¸Šä¼ åˆ° Release)
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: SubCheck-Portable-*.zip
          token: ${{ secrets.GITHUB_TOKEN }}
