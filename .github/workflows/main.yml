name: "Windows Portable Release Build"

on:
  push:
    tags: 
      - 'v*' # åœ¨æ¨é€ç‰ˆæœ¬æ ‡ç­¾æ—¶è§¦å‘
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build_windows_artifact:
    runs-on: windows-latest # ç¡®ä¿åœ¨ Windows ç¯å¢ƒä¸‹ç¼–è¯‘

    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v4

      # --- 1. å®‰è£…æ„å»ºç¯å¢ƒå’Œä¾èµ– ---
      - name: ğŸ› ï¸ Setup Go environment (for subs-check.exe)
        uses: actions/setup-go@v5
        with:
          go-version: '1.21' # æ›¿æ¢ä¸º subs-check å†…æ ¸æ‰€éœ€çš„ Go ç‰ˆæœ¬

      - name: ğŸ› ï¸ Setup .NET Core (for subs-check.win.gui.exe and DLLs)
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '6.0.x' # æ›¿æ¢ä¸º GUI é¡¹ç›®æ‰€éœ€çš„ .NET ç‰ˆæœ¬

      # --- 2. ç¼–è¯‘æ ¸å¿ƒ subs-check.exe å†…æ ¸ (Go) ---
      # å‡è®¾ Go å†…æ ¸ä»£ç åœ¨ ./subs-check-go-kernel
      - name: âš™ï¸ Build subs-check.exe (Go Kernel)
        run: |
          # ç¼–è¯‘ Go é¡¹ç›®å¹¶è¾“å‡ºåˆ°æ ¹ç›®å½•
          go build -ldflags "-s -w" -o subs-check.exe ./subs-check-go-kernel/cmd/main
        shell: powershell

      # --- 3. ç¼–è¯‘ subs-check.win.gui.exe (C# / .NET) ---
      # å‡è®¾æ‚¨çš„ GUI é¡¹ç›®æ–‡ä»¶æ˜¯ subs-check.win.gui.csproj
      - name: ğŸ–¥ï¸ Build GUI and Dependencies
        run: |
          $GuiProjectName = "YourGuiProject.sln" # æ›¿æ¢ä¸ºæ‚¨çš„ GUI è§£å†³æ–¹æ¡ˆå
          
          # å‘å¸ƒ GUI é¡¹ç›®ï¼Œç”Ÿæˆ EXE å’Œæ‰€æœ‰ä¾èµ– DLL/XML
          dotnet publish $GuiProjectName `
            --configuration Release `
            --runtime win-x86 ` # ç›®æ ‡å¹³å° i386 (x86)
            -o ${{ github.workspace }}/gui_build_output

          # å°†ç¼–è¯‘åçš„ä¸»è¦exeé‡å‘½åä¸º subs-check.win.gui.exe
          Rename-Item -Path ${{ github.workspace }}\gui_build_output\YourProjectName.exe -NewName "subs-check.win.gui.exe"
          
          # ç§»åŠ¨å…³é”®çš„ GUI æ–‡ä»¶åˆ°æ ¹ç›®å½•ï¼Œå‡†å¤‡æ‰“åŒ…
          Copy-Item -Path ${{ github.workspace }}\gui_build_output\subs-check.win.gui.exe -Destination ${{ github.workspace }}
          Copy-Item -Path ${{ github.workspace }}\gui_build_output\Newtonsoft.Json.dll -Destination ${{ github.workspace }}
          Copy-Item -Path ${{ github.workspace }}\gui_build_output\Newtonsoft.Json.xml -Destination ${{ github.workspace }}
          Copy-Item -Path ${{ github.workspace }}\gui_build_output\YamlDotNet.dll -Destination ${{ github.workspace }}
          Copy-Item -Path ${{ github.workspace }}\gui_build_output\YamlDotNet.xml -Destination ${{ github.workspace }}
          # ç¡®ä¿å…¶ä»– GUI è¿è¡Œæ—¶ä¾èµ–ä¹Ÿè¢«å¤åˆ¶åˆ°æ ¹ç›®å½•
          # ... (æ·»åŠ å…¶ä»–éœ€è¦çš„ DLL/æ–‡ä»¶)
          
        shell: powershell
        
      # --- 4. å‡†å¤‡å…¶ä»–æ–‡ä»¶å’Œç›®å½•ç»“æ„ ---
      - name: ğŸ“¦ Prepare Release Files
        shell: powershell
        run: |
          # åˆ›å»º config å’Œ output ç›®å½•
          New-Item -ItemType Directory -Path config
          New-Item -ItemType Directory -Path output
          
          # å¤åˆ¶é…ç½®æ–‡ä»¶æ¨¡æ¿åˆ° config ç›®å½•
          # å‡è®¾æ¨¡æ¿æ–‡ä»¶åœ¨ä»“åº“çš„ template_config ç›®å½•
          Copy-Item -Path template_config\config.yaml -Destination config
          Copy-Item -Path template_config\more.yaml -Destination config
          
          # å¤åˆ¶ Upgrade.exe å’Œ subs-check_Windows_i386.zipï¼ˆè¿™äº›åº”è¯¥æ˜¯é¢„å…ˆæ”¾åœ¨ä»“åº“ä¸­çš„æ–‡ä»¶ï¼‰
          Copy-Item -Path prebuilt\Upgrade.exe -Destination ${{ github.workspace }}
          Copy-Item -Path prebuilt\subs-check_Windows_i386.zip -Destination ${{ github.workspace }}

      # --- 5. å‹ç¼©æ‰€æœ‰æ–‡ä»¶åˆ° ZIP ---
      - name: ğŸ’¾ Compress All Files
        shell: powershell
        run: |
          $TagName = "${{ github.ref_name }}"
          $ZipName = "SubCheck-Portable-$TagName.zip"
          
          # é€‰æ‹©æ‰€æœ‰éœ€è¦çš„æ–‡ä»¶å’Œç›®å½•è¿›è¡Œå‹ç¼©
          Compress-Archive `
            -Path subs-check.exe, subs-check.win.gui.exe, Upgrade.exe, `
                    Newtonsoft.Json.dll, Newtonsoft.Json.xml, `
                    YamlDotNet.dll, YamlDotNet.xml, `
                    subs-check_Windows_i386.zip, `
                    config, output `
            -DestinationPath $ZipName

      # --- 6. ä¸Šä¼ åˆ° Release Assets ---
      - name: ğŸ“¤ Upload Release Asset
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: SubCheck-Portable-*.zip
          token: ${{ secrets.GITHUB_TOKEN }}
